---
title: "Poverty Data"
author: "Kathryn Linehan"
date: "2023-08-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(sf)
library(tmap)
```

```{r}
# read in data and filter to FFX

child_df <- read_csv("../data/distribution/ncr_tr_acs_2021_poverty_children.csv.xz", 
                     col_types = "cncnn") %>%
  filter(substr(geoid, start = 1, stop = 5) == "51059")
```

```{r}
# parse measure column

categories = strsplit(child_df$measure, split = "_")

child_df$race = ""
child_df$sex = ""
child_df$type = ""

for(i in 1:length(categories))
{
  v = categories[[i]]
  
  if("pov" %in% v)  # poverty measures
  {
    if(length(v) == 4)
    {
      child_df$race[i] = v[1]
      child_df$sex[i] = v[2]
      child_df$type[i] = paste(v[3], v[4], sep = "_")
    }
    else  # length is 5 -> wht_nonhis 
    {
      child_df$race[i] = paste(v[1], v[2], sep = "_")
      child_df$sex[i] = v[3]
      child_df$type[i] = paste(v[4], v[5], sep = "_")
    }
  }
  else  # total counts
  {
    if(length(v) == 3)
    {
      child_df$race[i] = v[1]
      child_df$sex[i] = v[2]
      child_df$type[i] = v[3]
    }
    else  # length is 4 -> wht_nonhis 
    {
      child_df$race[i] = paste(v[1], v[2], sep = "_")
      child_df$sex[i] = v[3]
      child_df$type[i] = v[4]
    }
  }
}

```

```{r}

child_df[child_df$race == 'wht', "race"] <- "White"
child_df[child_df$race == 'blk', "race"] <- "Black"
child_df[child_df$race == 'his', "race"] <- "Hispanic"
child_df[child_df$race == 'othr', "race"] <- "Other"
child_df[child_df$race == 'asian', "race"] <- "Asian"
child_df[child_df$race == 'wht_nonhis', "race"] <- "White (Non-Hispanic)"

```



```{r}
# plot for poverty counts

df <- child_df %>%
  filter(type == "pov_cnt")
  
ggplot(df, aes(x=race, y=value, fill=sex)) +
  geom_boxplot() +
  labs(title="Poverty by Race/Ethnicity by Sex for Children (<18)", 
       subtitle = "Each data point represents a census tract", x="Race/Ethnicity", y="Count", fill="Sex") +
  scale_x_discrete(labels=c("White (Non-Hispanic)"="White \n(Non-Hispanic)", 
                            "Hispanic (All Races)"="Hispanic \n(All Races)"),
                   limits = c("Asian", "Black", "Other", "White", "Hispanic (All Races)", "White (Non-Hispanic)")) +  
  theme(text = element_text(size = 14)) + 
  theme(legend.position = c(0.1, 0.8))

#ggsave("../docs/figures/poverty_counts_children.png")

```

```{r}
# plot for poverty percents

df <- child_df %>%
  filter(type == "pov_pct")
  
ggplot(df, aes(x=race, y=value, fill=sex)) +
  geom_boxplot() +
  labs(title="Poverty by Race/Ethnicity by Sex for Children (<18)", 
       subtitle = "Each data point represents a census tract", x="Race/Ethnicity", y="Percent", fill="Sex") +
  scale_x_discrete(labels=c("White (Non-Hispanic)"="White \n(Non-Hispanic)", 
                            "Hispanic (All Races)"="Hispanic \n(All Races)"),
                   limits = c("Asian", "Black", "Other", "White", "Hispanic (All Races)", "White (Non-Hispanic)")) + 
  theme(text = element_text(size = 14)) +
  theme(legend.position = c(0.9, 0.8))

#ggsave("../docs/figures/poverty_percents_children.png")
```

```{r}

# poverty counts and percents by boys/girls (no race) for the entire county

pov_df <- child_df %>%
  filter(type == "pov_cnt") %>%
  group_by(sex) %>%
  summarise(cnt = sum(value))

total_df <- child_df %>%
  filter(type == "cnt") %>%
  group_by(sex) %>%
  summarise(cnt = sum(value))
  
100*pov_df$cnt[1]/total_df$cnt[1]
100*pov_df$cnt[2]/total_df$cnt[2]

# boys listed first
 
```

```{r}

# find the 5 census tracts where each the count discrepancy is largest 

df <- child_df %>%
  filter(type == "pov_cnt") %>%
  group_by(geoid, race) %>%
  mutate(diff_w_m = value[sex == 'girls'] - value[sex == 'boys'])

df_u <- unique(df[ , c("geoid", "year", "race", "diff_w_m")])

# get 5 lowest values per group - where girls are not faring well

res <- df_u %>%
  arrange(desc(diff_w_m)) %>%
  group_by(race) %>%
  slice(1:5)

res$geoid <- as.character(res$geoid)
res$geoid <- substr(res$geoid,6,11)

```

```{r}
# plot

#race_labels = c("asian" = "Asian", "blk" = "Black", "his" = "Hispanic", "othr" = "Other", 
#                "wht" = "White", "wht_nonhis" = "White, non-Hispanic")

ggplot(res, aes(x=geoid, y=diff_w_m)) +
  geom_bar(stat = 'identity', fill = "navy") +
  facet_wrap(~race, nrow=2, scales = 'free_x') + #labeller = labeller(race = race_labels)) + 
  labs(title="Poverty Count Difference (Girls-Boys) by Race/Ethnicity (<18)", 
      x="Census Tract", y="Count Difference") +
  theme(axis.text.x = element_text(angle = 30)) +
  theme(text = element_text(size = 12))

ggsave("../docs/figures/poverty_differences_children.png")
```


```{r}
# maps by census tract for poverty count difference

# get geometry

va_geo <- sf::st_read("https://raw.githubusercontent.com/uva-bi-sdad/sdc.geographies/main/VA/Census%20Geographies/Tract/2020/data/distribution/va_geo_census_cb_2020_census_tracts.geojson")

df_maps <- st_as_sf(merge(df_u, va_geo[ ,c("geoid", "geometry")], by="geoid", all.x = TRUE))


```

```{r}
df_maps %>% 
  filter(race == "White") %>%
  ggplot() +
  geom_sf(aes(fill = diff_w_m)) + # fill = name of column with values to map
  labs(fill = "Difference", # Legend title
       title = "Poverty Count Difference (Girls-Boys) - 2021",  # Graph title
       subtitle = "White" ) + 
       #caption = "A great phrase explaining my figure \n
       #Data Source: American Community Survey, 5-Year Estimates, Table S1702") + 
        #Graph caption
  theme_void() # Takes out x and y axis, axis labels


```


```{r}
tmap_mode("plot")  # static view - not interactive

tm_shape(df_maps) +
    tm_polygons(col = "diff_w_m", 
                palette = "RdYlBu", 
                title = 'Difference',
                style = 'cont') +
    tm_facets(by = "race") +
    tm_layout(main.title = "Poverty Count Difference (Girls-Boys) - 2021")

```

```{r}

# find the 5 census tracts where each the percent discrepancy is largest 

df <- child_df %>%
  filter(type == "pov_pct") %>%
  group_by(geoid, race) %>%
  mutate(diff_w_m_pct = value[sex == 'girls'] - value[sex == 'boys'])

df_u <- unique(df[ , c("geoid", "year", "race", "diff_w_m_pct")])

# get 5 lowest values per group - where girls are not faring well

res <- df_u %>%
  arrange(desc(diff_w_m_pct)) %>%
  group_by(race) %>%
  slice(1:5)

```

```{r}
df_maps <- st_as_sf(merge(df_u, va_geo[ ,c("geoid", "geometry")], by="geoid", all.x = TRUE))
```


```{r}
tmap_mode("plot")  # static view - not interactive

tm_shape(df_maps) +
    tm_polygons(col = "diff_w_m_pct", 
                palette = "RdYlBu", 
                title = 'Difference',
                style = 'cont') +
    tm_facets(by = "race") +
    tm_layout(main.title = "Poverty Percent Difference (Girls-Boys) - 2021")
```

```{r}
#Or just plot counts and percents of girls in poverty?

w_df <- child_df %>%
  filter(sex == "girls" & type == "pov_cnt")  

w_df_maps <- st_as_sf(merge(w_df, va_geo[ ,c("geoid", "geometry")], by="geoid", all.x = TRUE))



```

```{r}
tmap_mode("plot")  # static view - not interactive

tm_shape(w_df_maps) +
    tm_polygons(col = "value", 
                palette = "YlOrBr", 
                title = 'Count',
                style = 'cont',
                breaks = c(0, 100, 200, 300),
                labels = c("0","100", "200", "300 and above")) +
    tm_facets(by = "race") +
    tm_layout(main.title = "Poverty Count (Girls) - 2021")

tmap_save(filename="../docs/figures/girls_count_map.png", asp=0.75)
```

```{r fig.height = 10, fig.width = 14}
#Or just plot counts and percents of girls in poverty?

w_df <- child_df %>%
  filter(sex == "girls" & type == "pov_pct")  

w_df_maps <- st_as_sf(merge(w_df, va_geo[ ,c("geoid", "geometry")], by="geoid", all.x = TRUE)) %>% filter(race != "White (Non-Hispanic)")

w_df_maps %>% 
  mutate(highlight = ifelse(value >= 45.97315, "yes", "no")) %>% 
ggplot() +
  facet_wrap(vars(race))+#, labeller = labeller(race = race.labs)) +
  geom_sf(aes(fill = value, color = highlight), lwd = 1) + # fill = name of column with values to map
  coord_sf(crs = st_crs(4269)) + 
  labs(#fill = ,
       title = "Percent of Girls in Poverty by Race and Ethnicity",
       caption = "Data Source: American Community Survey \n
       Girls (younger than 18), Fairfax County, Virginia, Census tracts, 2021", fill = "Percent") + 
  #caption = "A great phrase explaining my figure \n
  #Data Source: American Community Survey, 5-Year Estimates, Table S1702") + 
  scale_fill_distiller(palette = "Greens", direction = 1) +
  theme_void() + # Takes out x and y axis, axis labels 
  theme(legend.position = "bottom",
        text = element_text(size = 25),
        legend.key.width = unit(2, "cm")) +
  scale_color_manual(values = c("#00000000", "purple")) +
  guides(color = FALSE)
```

```{r}
tmap_mode("plot")  # static view - not interactive

tm_shape(w_df_maps) +
    tm_polygons(col = "value", 
                palette = "YlOrBr", 
                title = 'Percent',
                style = 'cont') +
    tm_facets(by = "race") +
    tm_layout(main.title = "Poverty Percent (Girls) - 2021")

tmap_save(filename="../docs/figures/girls_pct_map.png", asp=0.75)
```
